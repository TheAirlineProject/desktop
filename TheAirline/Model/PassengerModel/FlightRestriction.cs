using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using TheAirline.Model.GeneralModel;
using TheAirline.Model.AirlineModel;
using TheAirline.Model.GeneralModel.CountryModel;
using System.Reflection;
using System.Runtime.Serialization;


namespace TheAirline.Model.PassengerModel
{
    /*
     * The class for flight restrictions with no flights between two countries or unions
     */
    [Serializable]
    public class FlightRestriction : ISerializable
    {
        public enum RestrictionType { Flights, Airlines }
        [Versioning("type")]
        public RestrictionType Type { get; set; }
        [Versioning("startdate")]
        public DateTime StartDate { get; set; }
        [Versioning("enddate")]
        public DateTime EndDate { get; set; }
        [Versioning("from")]
        public BaseUnit From { get; set; }
        [Versioning("to")]
        public BaseUnit To { get; set; }
        public FlightRestriction(RestrictionType type, DateTime startDate, DateTime endDate, BaseUnit from, BaseUnit to)
        {
            this.Type = type;
            this.StartDate = startDate;
            this.EndDate = endDate;
            this.From = from;
            this.To = to;
        }
           private FlightRestriction(SerializationInfo info, StreamingContext ctxt)
        {
            int version = info.GetInt16("version");

            var fields = this.GetType().GetFields(BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public).Where(p => p.GetCustomAttribute(typeof(Versioning)) != null);

            IList<PropertyInfo> props = new List<PropertyInfo>(this.GetType().GetProperties(BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public).Where(p => p.GetCustomAttribute(typeof(Versioning)) != null));

            var propsAndFields = props.Cast<MemberInfo>().Union(fields.Cast<MemberInfo>());

            foreach (SerializationEntry entry in info)
            {
                MemberInfo prop = propsAndFields.FirstOrDefault(p => ((Versioning)p.GetCustomAttribute(typeof(Versioning))).Name == entry.Name);


                if (prop != null)
                {
                    if (prop is FieldInfo)
                        ((FieldInfo)prop).SetValue(this, entry.Value);
                    else
                        ((PropertyInfo)prop).SetValue(this, entry.Value);
                }
            }

            var notSetProps = propsAndFields.Where(p => ((Versioning)p.GetCustomAttribute(typeof(Versioning))).Version > version);

            foreach (MemberInfo notSet in notSetProps)
            {
                Versioning ver = (Versioning)notSet.GetCustomAttribute(typeof(Versioning));

                if (ver.AutoGenerated)
                {
                    if (notSet is FieldInfo)
                        ((FieldInfo)notSet).SetValue(this, ver.DefaultValue);
                    else
                        ((PropertyInfo)notSet).SetValue(this, ver.DefaultValue);

                }

            }
        }

        public void GetObjectData(SerializationInfo info, StreamingContext context)
        {
            info.AddValue("version", 1);

            Type myType = this.GetType();

            var fields = myType.GetFields(BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public).Where(p => p.GetCustomAttribute(typeof(Versioning)) != null);

            IList<PropertyInfo> props = new List<PropertyInfo>(myType.GetProperties(BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public).Where(p => p.GetCustomAttribute(typeof(Versioning)) != null));

            var propsAndFields = props.Cast<MemberInfo>().Union(fields.Cast<MemberInfo>());

            foreach (MemberInfo member in propsAndFields)
            {
                object propValue;

                if (member is FieldInfo)
                    propValue = ((FieldInfo)member).GetValue(this);
                else
                    propValue = ((PropertyInfo)member).GetValue(this, null);

                Versioning att = (Versioning)member.GetCustomAttribute(typeof(Versioning));

                info.AddValue(att.Name, propValue);
            }


        }
    }
    //the list of flight restrictions
    public class FlightRestrictions
    {
        private static List<FlightRestriction> restrictions = new List<FlightRestriction>();
        //adds a flight restriction to the list of restrictions
        public static void AddRestriction(FlightRestriction restriction)
        {
            restrictions.Add(restriction);
        }
        //returns all restrictions
        public static List<FlightRestriction> GetRestrictions()
        {
            return restrictions;
        }
        //celars the list
        public static void Clear()
        {
            restrictions.Clear();
        }
        //returns if there is flight restrictions from one country to another
        public static Boolean HasRestriction(Country from, Country to, DateTime date, FlightRestriction.RestrictionType type)
        {
        
            FlightRestriction restriction = GetRestrictions().Find(r=>(r.From == from || (r.From is Union && ((Union)r.From).isMember(from,date))) && (r.To == to || (r.To is Union && ((Union)r.To).isMember(to,date))) && (date>=r.StartDate && date<=r.EndDate) && r.Type == type);

            //FlightRestriction res = GetRestrictions().Find(r => r.From == from && r.To == to && r.Type == type);

            return restriction != null;
        }
        //returns if there is flight restrictions between two countries
        public static Boolean HasRestriction(Country country1, Country country2, DateTime date)
        {
            return HasRestriction(country1, country2, date, FlightRestriction.RestrictionType.Flights) || HasRestriction(country2, country1, date, FlightRestriction.RestrictionType.Flights);
        }
        //returns if there is flight restrictions for airlines to one of the destinations
        public static Boolean HasRestriction(Airline airline, Country dest1, Country dest2, DateTime date)
        {
            return HasRestriction(airline.Profile.Country, dest2, date, FlightRestriction.RestrictionType.Airlines) || HasRestriction(airline.Profile.Country,dest1,date,FlightRestriction.RestrictionType.Airlines);
        }
    }
}
